name: Deploy PR Preview

# This workflow deploys PR previews to Netlify to avoid conflicts with the main site.
# Each PR gets its own preview URL on Netlify with automatic cleanup.
# Netlify is widely adopted, actively maintained, and has excellent preview support.

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Required permissions to comment on PRs
permissions:
  pull-requests: write  # To comment on PR

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    
    steps:
      # Step 0: Check if Netlify secrets are configured
      - name: Check Netlify secrets
        run: |
          if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ] || [ -z "${{ secrets.NETLIFY_SITE_ID }}" ]; then
            echo "::error::Netlify secrets are not configured!"
            echo "::error::Please add NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID to repository secrets."
            echo "::error::See .github/workflows/README.md for setup instructions."
            exit 1
          fi
          echo "âœ“ Netlify secrets are configured"
          echo "Site ID length: ${#NETLIFY_SITE_ID}"
          echo "Site ID starts with: ${NETLIFY_SITE_ID:0:8}..."
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      
      # Step 1: Checkout the PR branch
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Set up Ruby environment
      # Installs Ruby and sets up bundler with automatic gem caching
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # Step 3: Install system dependencies required by jekyll_picture_tag
      # The jekyll_picture_tag plugin requires libvips and related libraries for image processing
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libvips-tools \
            libvips-dev \
            liblcms2-dev \
            libopenjp2-7-dev \
            libpng-dev \
            libwebp-dev \
            libheif-dev \
            imagemagick \
            libjxl-dev \
            libpoppler-glib-dev

      # Step 4: Build Jekyll site for PR preview
      # Build without baseurl since Netlify serves from root
      - name: Build Jekyll site for PR preview
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      # Step 5: Deploy to Netlify
      # Uses the official Netlify CLI to deploy
      # Each PR gets a unique deploy preview URL
      - name: Deploy to Netlify
        id: netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './_site'
          production-deploy: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from PR #${{ github.event.pull_request.number }}"
          alias: pr-${{ github.event.pull_request.number }}
          netlify-config-path: ./netlify.toml
          enable-pull-request-comment: false
          enable-commit-comment: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 5

      # Step 6: Comment on PR with preview URL
      # Creates or updates a comment with the preview link
      - name: Comment on PR with preview URL
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const previewUrl = `${{ steps.netlify.outputs.deploy-url }}`;
            
            const body = `ðŸš€ **Preview deployment ready!**\n\nView your changes at: ${previewUrl}\n\nâœ¨ Powered by Netlify - auto-updates on every commit and auto-deletes when PR is closed.`;
            
            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview deployment')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
      
      # Step 7: Comment on error if deployment failed
      - name: Comment on deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            
            let body = `âŒ **Preview deployment failed!**\n\n`;
            
            // Check if it's a secrets issue
            const hasAuthToken = !!process.env.NETLIFY_AUTH_TOKEN;
            const hasSiteId = !!process.env.NETLIFY_SITE_ID;
            
            if (!hasAuthToken || !hasSiteId) {
              body += `**Issue**: Netlify secrets are missing.\n\n`;
              if (!hasAuthToken) body += `- Missing: \`NETLIFY_AUTH_TOKEN\`\n`;
              if (!hasSiteId) body += `- Missing: \`NETLIFY_SITE_ID\`\n`;
              body += `\n**To fix**:\n`;
              body += `1. Go to [Netlify](https://app.netlify.com/) and create a site\n`;
              body += `2. Get your Site ID from Site settings > General > Site information\n`;
              body += `3. Generate a Personal Access Token in User settings > Applications\n`;
              body += `4. Add secrets to repository (Settings > Secrets and variables > Actions)\n\n`;
              body += `See [setup instructions](.github/workflows/README.md) for details.`;
            } else {
              body += `**Common issues**:\n\n`;
              body += `1. **Site not found**: Verify your \`NETLIFY_SITE_ID\` is correct\n`;
              body += `   - Go to Netlify Site settings > General > Site information\n`;
              body += `   - Copy the exact Site ID (looks like: \`abc12345-6789-...\`)\n\n`;
              body += `2. **Invalid token**: Verify your \`NETLIFY_AUTH_TOKEN\` is valid\n`;
              body += `   - Generate a new token in User settings > Applications\n`;
              body += `   - Make sure it's a Personal Access Token, not a Deploy Key\n\n`;
              body += `3. **Permissions**: Ensure the token has permission to deploy\n\n`;
              body += `Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
